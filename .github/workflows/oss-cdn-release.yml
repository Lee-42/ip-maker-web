name: Build and Upload CDN Bundle to OSS

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      objectPrefix:
        description: "(可选) OSS 前缀，例如 releases/v1.2.3/，留空则上传到桶根目录"
        required: false
        default: ""

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
      OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
      OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      OSS_OBJECT_PREFIX: ${{ inputs.objectPrefix || '' }}
      VITE_WOWNOW_API_BASE: ${{ secrets.VITE_WOWNOW_API_BASE }}
      VITE_WOWNOW_CHAT_BASE: ${{ secrets.VITE_WOWNOW_CHAT_BASE }}
      VITE_WOWNOW_NFC_BASE: ${{ secrets.VITE_WOWNOW_NFC_BASE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web bundle
        run: pnpm build --mode production

      - name: Download ossutil64
        run: |
          curl -L "https://gosspublic.alicdn.com/ossutil/1.7.20/ossutil64" -o ossutil64
          chmod +x ossutil64

      - name: Upload dist to OSS
        env:
          OBJECT_PREFIX: ${{ env.OSS_OBJECT_PREFIX }}
        run: |
          DEST_PATH="oss://${OSS_BUCKET}"
          if [ -n "${OBJECT_PREFIX}" ]; then
            DEST_PATH="${DEST_PATH%/}/${OBJECT_PREFIX%/}/"
          else
            DEST_PATH="${DEST_PATH%/}/"
          fi
          echo "Uploading dist/ to ${DEST_PATH}"
          ./ossutil64 cp dist/ "$DEST_PATH" -rf --endpoint "${OSS_ENDPOINT}" --access-key-id "${OSS_ACCESS_KEY_ID}" --access-key-secret "${OSS_ACCESS_KEY_SECRET}"

      - name: (Optional) Print CDN hint
        run: echo "Upload complete. Please ensure your CDN加速域名已绑定 OSS 源站，并按需执行刷新/预热。"
